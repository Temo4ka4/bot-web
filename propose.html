<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –î–ó</title>
  <style>
    :root{--bg:#fff;--card:#fff;--text:#111;--muted:#666;--shadow:0 10px 25px rgba(0,0,0,.08);--border:#e9e9ef;--btn:#111;--btnText:#fff}
    [data-theme="dark"]{--bg:#0f1115;--card:#141824;--text:#f2f3f5;--muted:#a6adbb;--shadow:0 10px 25px rgba(0,0,0,.35);--border:#262b3a;--btn:#f2f3f5;--btnText:#111}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .top{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));backdrop-filter:saturate(1.2) blur(6px);padding:14px 16px 10px;display:flex;align-items:center;gap:12px}
    .title{font-weight:900;font-size:18px}
    .sp{flex:1}
    .toggle{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted);user-select:none}
    .switch{width:44px;height:24px;border-radius:999px;background:var(--border);position:relative;cursor:pointer}
    .knob{width:18px;height:18px;border-radius:50%;background:var(--card);position:absolute;top:3px;left:3px;box-shadow:var(--shadow);transition:.18s}
    [data-theme="dark"] .knob{left:23px}
    .wrap{padding:10px 16px 18px;max-width:820px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:10px 0}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:14px;padding:10px 12px;font-size:14px}
    textarea{min-height:130px;resize:vertical;white-space:pre-wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:220px}
    button{border:0;border-radius:14px;padding:12px 14px;font-weight:900;background:var(--btn);color:var(--btnText);cursor:pointer;width:100%}
    .empty{padding:22px;border:1px dashed var(--border);border-radius:18px;color:var(--muted);text-align:center}
    .ok{color:#22c55e;font-weight:900}
    .bad{color:#ff5a5f;font-weight:900}
    .hint{color:var(--muted);font-size:12px;margin-top:10px}
  </style>
</head>
<body>
  <div class="top">
    <div class="title">‚úâÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –î–ó</div>
    <div class="sp"></div>
    <div class="toggle" id="toggle"><span>–¢–µ–º–∞</span><div class="switch"><div class="knob"></div></div></div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label>–î–∞—Ç–∞ (–≤—Ä—É—á–Ω—É—é)</label>
          <input id="day" placeholder="YYYY-MM-DD (–Ω–∞–ø—Ä–∏–º–µ—Ä 2025-12-19)"/>
        </div>
        <div>
          <label>–ü—Ä–µ–¥–º–µ—Ç</label>
          <select id="subject"></select>
        </div>
      </div>

      <label>–î–æ–º–∞—à–∫–∞</label>
      <textarea id="text" placeholder="–ù–∞–ø–∏—à–∏ –¥–æ–º–∞—à–∫—É –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º‚Ä¶"></textarea>

      <div style="margin-top:12px">
        <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
      </div>

      <div class="hint" id="status"></div>
    </div>

    <div id="list"></div>
  </div>

<script>
  const API_BASE = "https://api.temo4ka4.ru";
  const tg = window.Telegram?.WebApp || null;
  if (tg) tg.ready();

  function setTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
  }
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") setTheme("dark");
  else setTheme("light");
  document.getElementById("toggle").onclick = () => {
    const cur = document.documentElement.getAttribute("data-theme");
    setTheme(cur === "light" ? "dark" : "light");
  };

  function esc(s){return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
  function showMessage(title, text){
    document.getElementById("list").innerHTML = `<div class="empty"><b>${esc(title)}</b><br/>${esc(text)}</div>`;
  }
  function ensureTelegram(){
    if (!tg || !tg.initData) {
      showMessage("‚ö†Ô∏è –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram", "–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–∑ –±–æ—Ç–∞.");
      return false;
    }
    return true;
  }
  async function safeFetch(path, opts){
    if (!ensureTelegram()) throw new Error("NO_TELEGRAM");
    try{
      const r = await fetch(API_BASE + path, {
        ...(opts||{}),
        headers: {
          ...((opts&&opts.headers)||{}),
          "X-Telegram-InitData": tg.initData
        }
      });
      if(!r.ok) throw new Error("SERVER_ERROR");
      return await r.json();
    }catch(e){
      showMessage("üîå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "–ü–æ–∫–∞ backend API –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.");
      throw e;
    }
  }

  function setStatus(html){ document.getElementById("status").innerHTML = html; }

  (async ()=>{
    try{
      const data = await safeFetch("/api/subjects");
      const sel = document.getElementById("subject");
      sel.innerHTML = "";
      for (const s of (data.subjects||[])) {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      }
      setStatus("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞—Ç—É, –ø—Ä–µ–¥–º–µ—Ç –∏ —Ç–µ–∫—Å—Ç.");
    }catch(_){}
  })();

  document.getElementById("send").onclick = async ()=>{
    const day = (document.getElementById("day").value||"").trim();
    const subject = document.getElementById("subject").value || "üßæ –û–±—â–µ–µ";
    const text = (document.getElementById("text").value||"").trim();

    if(!day){ setStatus(`<span class="bad">–í–ø–∏—à–∏ –¥–∞—Ç—É.</span>`); return; }
    if(!/^\d{4}-\d{2}-\d{2}$/.test(day)){ setStatus(`<span class="bad">–î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD.</span>`); return; }
    if(!text){ setStatus(`<span class="bad">–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –î–ó.</span>`); return; }

    setStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶");

    try{
      await safeFetch("/api/propose", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ day, subject, text })
      });
      setStatus(`<span class="ok">‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É/–º–æ–¥–µ—Ä–∞–º –∫–ª–∞—Å—Å–∞.</span>`);
      document.getElementById("text").value = "";
    }catch(_){}
  };
</script>
</body>
</html>

