<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>–î–ó ‚Ä¢ WebApp</title>

  <style>
    :root{
      --bg: #f4f5f7;
      --surface: rgba(255,255,255,.75);
      --surface-strong: #ffffff;
      --text: #0f172a;
      --muted: rgba(15, 23, 42, .62);
      --line: rgba(15, 23, 42, .10);
      --shadow: 0 18px 50px rgba(0,0,0,.10);
      --shadow-soft: 0 10px 30px rgba(0,0,0,.08);

      --accent: #007aff;
      --accent-2: #5ac8fa;

      --good: #34c759;
      --warn: #ff9500;
      --bad: #ff3b30;

      --radius: 18px;
      --radius2: 24px;

      --tap: rgba(0, 122, 255, .12);
      --chip: rgba(0,0,0,.06);
      --chip2: rgba(0,0,0,.10);

      --sidebar-w: 320px;
      --max-w: 1200px;

      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);

      --scale: 1;
    }

    html[data-accent="purple"]{
      --accent: #8b5cf6;
      --accent-2: #a78bfa;
      --tap: rgba(139, 92, 246, .16);
    }
    html[data-accent="mint"]{
      --accent: #14b8a6;
      --accent-2: #2dd4bf;
      --tap: rgba(20, 184, 166, .16);
    }

    html[data-theme="dark"]{
      --bg: #0b1020;
      --surface: rgba(18, 24, 42, .65);
      --surface-strong: #12182a;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --line: rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --shadow-soft: 0 10px 30px rgba(0,0,0,.40);

      --chip: rgba(255,255,255,.08);
      --chip2: rgba(255,255,255,.12);
    }

    html[data-text="s"]{ --scale: .94; }
    html[data-text="m"]{ --scale: 1.00; }
    html[data-text="l"]{ --scale: 1.10; }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(900px 450px at 15% 10%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 55%),
        radial-gradient(700px 380px at 85% 20%, color-mix(in srgb, var(--accent-2) 26%, transparent), transparent 55%),
        radial-gradient(900px 540px at 60% 90%, rgba(52,199,89,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height: 100svh;
      padding: calc(16px + var(--safe-top)) calc(16px + var(--safe-right)) calc(16px + var(--safe-bot)) calc(16px + var(--safe-left));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;

      font-size: calc(14px * var(--scale));
    }

    body.modal-open{
      height: 100svh;
      overflow: hidden;
      touch-action: none;
    }

    .app{
      max-width: var(--max-w);
      margin: 0 auto;
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--line);
      background: var(--surface);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .sidebar{
      position: sticky;
      top: calc(16px + var(--safe-top));
      padding: 18px;
    }
    @media (max-width: 980px){
      .sidebar{ position: relative; top: 0; }
    }

    .brand{
      display: flex;
      gap: 12px;
      align-items: center;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 14px;
    }

    .logo{
      width: 42px; height: 42px;
      border-radius: 14px;
      background:
        radial-gradient(12px 12px at 25% 35%, rgba(255,255,255,.9), rgba(255,255,255,0) 55%),
        linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 12px 25px color-mix(in srgb, var(--accent) 22%, transparent);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 900;
      letter-spacing: -0.5px;
      user-select: none;
    }

    .brand h1{
      font-size: calc(16px * var(--scale));
      margin: 0;
      line-height: 1.2;
      letter-spacing: -0.2px;
    }
    .brand p{
      margin: 4px 0 0 0;
      font-size: calc(12px * var(--scale));
      color: var(--muted);
    }

    .section-title{
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      letter-spacing: .18em;
      text-transform: uppercase;
      margin: 14px 2px 10px;
    }

    .pill{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
    }

    .pill-btn{
      width: 100%;
      cursor: pointer;
      user-select: none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px 12px;
      text-align: left;
      color: var(--text);
    }
    .pill-btn:active{ background: var(--tap); }

    .pill .left{
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .icon{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: var(--chip);
      border: 1px solid var(--line);
      display: grid;
      place-items: center;
      font-size: calc(16px * var(--scale));
      user-select: none;
    }

    .pill .meta{ min-width: 0; }
    .pill .meta .t{
      font-size: calc(13px * var(--scale));
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pill .meta .s{
      font-size: calc(12px * var(--scale));
      margin: 2px 0 0 0;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hint{
      margin: 12px 2px 0;
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      line-height: 1.45;
    }

    .main{ padding: 14px; }

    .topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 6px 12px;
    }
    .topbar .title{ display: flex; flex-direction: column; gap: 2px; }
    .topbar h2{
      margin: 0;
      font-size: calc(18px * var(--scale));
      letter-spacing: -0.3px;
      line-height: 1.2;
    }
    .topbar .sub{
      margin: 0;
      font-size: calc(12px * var(--scale));
      color: var(--muted);
    }

    .chip{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      white-space: nowrap;
    }

    .tabs{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
    }
    .tabs::-webkit-scrollbar{ display: none; }
    .tab{
      scroll-snap-align: start;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: calc(13px * var(--scale));
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      cursor: pointer;
      transition: .15s ease;
      user-select: none;
    }
    .tab:active{ background: var(--tap); }
    .tab[data-active="true"]{
      background: var(--surface-strong);
      border-color: var(--line);
      color: var(--text);
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }

    .pages{
      margin-top: 12px;
      display: flex;
      gap: 12px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--radius2);
    }
    .pages::-webkit-scrollbar{ display: none; }

    .page{
      scroll-snap-align: start;
      flex: 0 0 100%;
      min-width: 100%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius2);
      padding: 14px;
    }

    .page-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .page-head h3{
      margin: 0;
      font-size: calc(15px * var(--scale));
      letter-spacing: -0.2px;
    }
    .page-head .note{
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      margin: 0;
    }

    .skeleton{
      border: 1px dashed var(--line);
      border-radius: 16px;
      padding: 12px;
      color: var(--muted);
      font-size: calc(13px * var(--scale));
      line-height: 1.5;
      background: rgba(255,255,255,.04);
    }

    .hw-list{
      display: grid;
      gap: 12px;
      margin-top: 10px;
    }

    .hw-card{
      border-radius: 18px;
      border: 1px solid var(--line);
      background: var(--surface-strong);
      box-shadow: 0 12px 28px rgba(0,0,0,.06);
      padding: 12px 12px;
      position: relative;
    }
    .hw-card.done{
      opacity: .72;
    }
    .hw-card.done .hw-title{
      text-decoration: line-through;
      text-decoration-thickness: 2px;
      text-decoration-color: color-mix(in srgb, var(--muted) 70%, transparent);
    }

    .hw-top{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .hw-title{
      margin: 0;
      font-size: calc(14px * var(--scale));
      letter-spacing: -0.2px;
      line-height: 1.25;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .hw-date{
      margin: 2px 0 0 0;
      font-size: calc(12px * var(--scale));
      color: var(--muted);
    }
    .hw-text{
      margin: 10px 0 0;
      font-size: calc(13px * var(--scale));
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .badge{
      flex: 0 0 auto;
      font-size: calc(12px * var(--scale));
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge.good{ color: var(--good); border-color: rgba(52,199,89,.35); background: rgba(52,199,89,.10); }
    .badge.warn{ color: var(--warn); border-color: rgba(255,149,0,.35); background: rgba(255,149,0,.10); }

    .hw-actions{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .iconbtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      font-size: calc(15px * var(--scale));
    }
    .iconbtn:active{ background: var(--tap); transform: translateY(1px); }

    .checkwrap{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    .checkwrap input{
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .row{
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
      margin-top: 10px;
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }

    .field{ display: grid; gap: 6px; }
    label{
      font-size: calc(12px * var(--scale));
      color: var(--muted);
    }
    input[type="date"], input[type="text"], textarea, input[type="search"]{
      width: 100%;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      color: var(--text);
      outline: none;
      font-size: calc(14px * var(--scale));
    }
    textarea{
      resize: vertical;
      min-height: 110px;
      line-height: 1.4;
    }

    .btns{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .btn{
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 11px 12px;
      font-size: calc(13px * var(--scale));
      cursor: pointer;
      user-select: none;
      transition: .15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, transparent);
      color: var(--text);
    }
    .btn:active{ transform: translateY(1px); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--safe-bot));
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.78);
      color: #fff;
      font-size: calc(12px * var(--scale));
      opacity: 0;
      pointer-events: none;
      transition: .18s ease;
      max-width: calc(100vw - 26px);
      text-align: center;
      z-index: 140;
    }
    html[data-theme="dark"] .toast{
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.12);
    }
    .toast.show{ opacity: 1; }

    .small{
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      line-height: 1.45;
      margin: 10px 0 0;
    }

    /* ===== Splash loader ===== */
    .splash{
      position: fixed;
      inset: 0;
      z-index: 200;
      display: grid;
      place-items: center;
      background:
        radial-gradient(900px 450px at 15% 10%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 55%),
        radial-gradient(700px 380px at 85% 20%, color-mix(in srgb, var(--accent-2) 26%, transparent), transparent 55%),
        radial-gradient(900px 540px at 60% 90%, rgba(52,199,89,.10), transparent 60%),
        var(--bg);
      transition: opacity .25s ease, transform .25s ease;
    }
    .splash.hide{
      opacity: 0;
      transform: scale(1.01);
      pointer-events: none;
    }
    .splash-card{
      width: min(360px, calc(100vw - 36px));
      border-radius: 24px;
      border: 1px solid var(--line);
      background: var(--surface);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
      padding: 18px;
      display: grid;
      gap: 12px;
      justify-items: center;
      text-align: center;
    }
    .spinner{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,.10);
      border-top-color: color-mix(in srgb, var(--accent) 85%, transparent);
      animation: spin .85s linear infinite;
    }
    html[data-theme="dark"] .spinner{
      border-color: rgba(255,255,255,.14);
      border-top-color: color-mix(in srgb, var(--accent-2) 95%, transparent);
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
    .splash-title{
      font-weight: 900;
      letter-spacing: -0.2px;
      font-size: calc(15px * var(--scale));
    }
    .splash-sub{
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      line-height: 1.45;
      margin: 0;
    }
    .progress{
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(0,0,0,.08);
      overflow: hidden;
      border: 1px solid var(--line);
    }
    html[data-theme="dark"] .progress{ background: rgba(255,255,255,.08); }
    .progress .bar{
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 999px;
      animation: indet 1.05s ease-in-out infinite;
    }
    @keyframes indet{
      0%{ transform: translateX(-120%); }
      100%{ transform: translateX(320%); }
    }
    .tip{
      margin-top: -4px;
      font-size: calc(12px * var(--scale));
      color: var(--muted);
      line-height: 1.35;
    }

    /* ===== Overlay sheets ===== */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 160;
      display: none;
      background: rgba(0,0,0,.36);
      padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-right)) calc(12px + var(--safe-bot)) calc(12px + var(--safe-left));
    }
    .overlay.show{
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    .sheet{
      width: min(560px, 100%);
      max-height: calc(100svh - 24px - var(--safe-top) - var(--safe-bot));
      border-radius: 26px;
      border: 1px solid var(--line);
      background: var(--surface-strong);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .sheet-head{
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--surface);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .sheet-title{
      font-weight: 900;
      letter-spacing: -.2px;
      font-size: calc(14px * var(--scale));
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .sheet-body{
      padding: 12px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    .setting{
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: rgba(255,255,255,.04);
      margin-bottom: 10px;
    }
    .setting-top{
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .setting-name{
      margin: 0;
      font-weight: 800;
      letter-spacing: -.2px;
      font-size: calc(13px * var(--scale));
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .setting-desc{
      margin: 4px 0 0 0;
      color: var(--muted);
      font-size: calc(12px * var(--scale));
      line-height: 1.35;
    }

    .seg{
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .seg button{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: calc(12px * var(--scale));
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .seg button:active{ background: var(--tap); }
    .seg button[data-on="true"]{
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, transparent);
    }

    .searchbar{
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .searchbar .sicon{
      font-size: calc(14px * var(--scale));
      color: var(--muted);
      user-select: none;
    }
    .searchbar input{
      border: 0;
      background: transparent;
      padding: 0;
      outline: none;
      font-size: calc(14px * var(--scale));
      color: var(--text);
    }
    .searchbar .clear{
      margin-left: auto;
      width: 30px;
      height: 30px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      font-size: calc(13px * var(--scale));
    }
    .searchbar .clear:active{ background: var(--tap); }

    .muted-link{
      color: var(--muted);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
  
    /* ‚ùÑÔ∏è Snow overlay (–≤–∏–¥–Ω–æ –∏ –≤ —Å–≤–µ—Ç–ª–æ–π, –∏ –≤ —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ) */
html{ --snow1: rgba(0,0,0,.10); --snow2: rgba(0,0,0,.06); }
html[data-theme="dark"]{ --snow1: rgba(255,255,255,.45); --snow2: rgba(255,255,255,.25); }

body::before{
  content:"";
  position:fixed;
  inset:-20px;
  pointer-events:none;
  opacity: .55;
  background-image:
    radial-gradient(circle at 12% 18%, var(--snow1) 0 1.6px, transparent 2.2px),
    radial-gradient(circle at 28% 72%, var(--snow2) 0 1.2px, transparent 2.0px),
    radial-gradient(circle at 70% 28%, var(--snow2) 0 1.4px, transparent 2.1px),
    radial-gradient(circle at 84% 62%, var(--snow1) 0 1.1px, transparent 1.9px),
    radial-gradient(circle at 48% 44%, var(--snow2) 0 1.2px, transparent 2.0px),
    radial-gradient(circle at 6% 86%,  var(--snow2) 0 1.0px, transparent 1.8px),
    radial-gradient(circle at 94% 12%, var(--snow2) 0 1.0px, transparent 1.8px);
  background-size: 420px 420px;
  background-repeat: repeat;
}
 .app{ position: relative; z-index: 1; }

    /* üõ† –¢–µ—Ö—Ä–∞–±–æ—Ç—ã: fullscreen-–æ–≤–µ—Ä–ª–µ–π (–±–µ–∑ –∫—Ä–µ—Å—Ç–∏–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∞–±—É–∑–∏–ª–∏) */
    .tech-overlay{
      position: fixed;
      inset: 0;
      z-index: 99999;
      display: none;
      padding: max(16px, env(safe-area-inset-top)) 14px max(18px, env(safe-area-inset-bottom));
      background: rgba(6, 10, 20, .82);
      backdrop-filter: blur(10px);
    }
    .tech-overlay.on{
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tech-card{
      width: min(720px, 100%);
      border-radius: 22px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.92);
      color: #0f172a;
      box-shadow: 0 28px 90px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .tech-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
    }
    .tech-head b{ font-size: 15px; }
    .tech-body{ padding: 14px 16px 16px; }
    .tech-row{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      background: rgba(15,23,42,.06);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .tech-ico{
      width: 36px; height: 36px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(15,23,42,.06);
      border: 1px solid rgba(15,23,42,.10);
      flex:0 0 auto;
    }
    .tech-row b{ display:block; margin-bottom: 4px; }
    .tech-row p{ margin:0; color: rgba(15,23,42,.72); font-size: 13px; line-height: 1.35; }
    .tech-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .tech-btn{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      color:#0f172a;
      cursor:pointer;
      font-weight: 600;
    }
    .tech-btn.primary{
      background: rgba(96,165,250,.20);
      border-color: rgba(96,165,250,.55);
    }
    .tech-btn.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.45);
    }
    .tech-note{
      margin-top: 10px;
      color: rgba(15,23,42,.62);
      font-size: 12px;
      line-height: 1.35;
    }

    /* ‚öôÔ∏è –õ–æ–≥–æ—Ç–∏–ø—ã-–∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
    #logoSeg button{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      padding: 0;
      overflow: hidden;
      display: grid;
      place-items: center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.08);
    }
    #logoSeg button img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    /* –†–µ–∂–∏–º "–∫–∞—Ä—Ç–∏–Ω–∫–∞" –¥–ª—è .logo */
    .logo.is-img{
      background: none !important;
      overflow: hidden;
      padding: 0 !important;
    }
    .logo.is-img img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      border-radius: inherit;
    }

  </style>
</head>

<body>
  <!-- üõ† Fullscreen —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã (–±–µ–∑ –∫—Ä–µ—Å—Ç–∏–∫–∞) -->
  <div class="tech-overlay" id="techOverlay" aria-hidden="true">
    <div class="tech-card" role="dialog" aria-modal="true">
      <div class="tech-head">
        <b id="techTitle">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</b>
      </div>
      <div class="tech-body">
        <div class="tech-row">
          <div class="tech-ico">üõ†</div>
          <div>
            <b id="techHead">–°–µ—Ä–≤–∏—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è</b>
            <p id="techMsg">–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å—ã. –ü–æ–∫–∞–∑ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ.</p>
          </div>
        </div>

        <div class="tech-actions">
          <button class="tech-btn primary" id="techRetry">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          <button class="tech-btn danger" id="techExit">–í—ã–π—Ç–∏</button>
          <button class="tech-btn" id="techDev">–ù–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</button>
        </div>

        <div class="tech-note">–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —É—Ö–æ–¥–∏—Ç ‚Äî —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã –µ—â—ë –∏–¥—É—Ç. –ü—Ä–æ—Å—Ç–æ –∑–∞–π–¥–∏ –ø–æ–∑–∂–µ.</div>
      </div>
    </div>
  </div>


  <!-- Splash (min 3 sec) -->
  <div class="splash" id="splash">
    <div class="splash-card">
      <div class="logo" id="splashLogo" style="width:56px;height:56px;border-radius:18px;">DZ</div>
      <div class="spinner" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞"></div>
      <div class="splash-title" id="splashTitle">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
      <p class="splash-sub" id="splashSub">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–º–∞—à–∫—É‚Ä¶</p>
      <div class="progress" aria-hidden="true"><div class="bar"></div></div>
      <div class="tip" id="splashTip">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏ üìã, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –î–ó.</div>
    </div>
  </div>

  <!-- Mini splash for settings -->
  <div class="splash" id="miniSplash" style="display:none;">
    <div class="splash-card">
      <div class="logo" id="miniLogo" style="width:56px;height:56px;border-radius:18px;">DZ</div>
      <div class="spinner" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞"></div>
      <div class="splash-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <p class="splash-sub" id="miniSub">–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏‚Ä¶</p>
      <div class="progress" aria-hidden="true"><div class="bar"></div></div>
      <div class="tip" id="miniTip">–°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.</div>
    </div>
  </div>

  <!-- Settings overlay -->
  <div class="overlay" id="settingsOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
      <div class="sheet-head">
        <div class="sheet-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <button class="iconbtn" id="closeSettings" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="sheet-body">

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üé® –¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</p>
              <p class="setting-desc">–°—Ç–∞–Ω–¥–∞—Ä—Ç / –§–∏–æ–ª–µ—Ç–æ–≤–∞—è / –ú—è—Ç–Ω–∞—è</p>
            </div>
            <div class="seg" id="accentSeg">
              <button data-accent="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç</button>
              <button data-accent="purple">–§–∏–æ–ª–µ—Ç</button>
              <button data-accent="mint">–ú—è—Ç–∞</button>
            </div>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üåì –†–µ–∂–∏–º</p>
              <p class="setting-desc">–°–≤–µ—Ç–ª—ã–π / –¢—ë–º–Ω—ã–π</p>
            </div>
            <div class="seg" id="modeSeg">
              <button data-mode="light">–°–≤–µ—Ç–ª—ã–π</button>
              <button data-mode="dark">–¢—ë–º–Ω—ã–π</button>
            </div>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üß© –õ–æ–≥–æ—Ç–∏–ø –≤ —à–∞–ø–∫–µ</p>
              <p class="setting-desc">DZ / –ö–Ω–∏–≥–∞ / –¢–µ—Ç—Ä–∞–¥—å / –®–∫–æ–ª–∞ / –°–æ–≤–∞</p>
            </div>
            
            <div class="seg" id="logoSeg">
              <button data-logo="logo1" title="–õ–æ–≥–æ 1"><img src="klasik.jpg" alt="logo1"></button>
              <button data-logo="logo2" title="–õ–æ–≥–æ 2"><img src="logo2.jpg" alt="logo2"></button>
              <button data-logo="logo3" title="–õ–æ–≥–æ 3"><img src="logo3.webp" alt="logo3"></button>
              <button data-logo="logo4" title="–õ–æ–≥–æ 4"><img src="logo4.jpg" alt="logo4"></button>
              <button data-logo="logo5" title="–õ–æ–≥–æ 5"><img src="logo5.webp" alt="logo5"></button>
            </div>

          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üôÇ –≠–º–æ–¥–∑–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>
              <p class="setting-desc">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏ –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º</p>
            </div>
            <div class="seg" id="emojiSeg">
              <button data-emoji="on">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å</button>
              <button data-emoji="off">–°–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">‚úÖ –û—Ç–º–µ—Ç–∫–∏ ‚Äú—Å–¥–µ–ª–∞–Ω–æ‚Äù</p>
              <p class="setting-desc">–ì–∞–ª–æ—á–∫–∏ –≤–æ–∑–ª–µ –∫–∞–∂–¥–æ–≥–æ –î–ó</p>
            </div>
            <div class="seg" id="doneSeg">
              <button data-done="on">–í–∫–ª</button>
              <button data-done="off">–í—ã–∫–ª</button>
            </div>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üî† –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</p>
              <p class="setting-desc">–í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–ø—Ä–∏–º–µ—Ä ‚ÄúAa‚Äù)</p>
            </div>
            <div class="seg" id="textSeg">
              <button data-text="s"><span style="font-size:12px;">Aa</span> S</button>
              <button data-text="m"><span style="font-size:14px;">Aa</span> M</button>
              <button data-text="l"><span style="font-size:16px;">Aa</span> L</button>
            </div>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</p>
              <p class="setting-desc">–û–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏, –µ—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª</p>
            </div>
            <div class="seg" id="autoSeg">
              <button data-auto="on">–í–∫–ª</button>
              <button data-auto="off">–í—ã–∫–ª</button>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <div style="color:var(--muted); font-size:calc(12px * var(--scale));">–°—á–∏—Ç–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º —á–µ—Ä–µ–∑:</div>
            <div class="seg" id="staleSeg">
              <button data-stale="5">5–º</button>
              <button data-stale="15">15–º</button>
              <button data-stale="30">30–º</button>
              <button data-stale="60">60–º</button>
            </div>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üßΩ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞</p>
              <p class="setting-desc">–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å ‚Äî –æ—á–∏—Å—Ç–∏ –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–π–¥–∏</p>
            </div>
            <div class="seg" id="confirmSeg">
              <button data-confirm="on">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å</button>
              <button data-confirm="off">–ë–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</button>
            </div>
          </div>
          <div class="btns">
            <button class="btn" id="clearCacheBtn">üßΩ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
          </div>
        </div>

        <div class="setting">
          <div class="setting-top">
            <div>
              <p class="setting-name">üêû –û—à–∏–±–∫–∞ / –æ—Ç—á—ë—Ç</p>
              <p class="setting-desc">–û—Ç–∫—Ä–æ–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞</p>
            </div>
            <div class="seg">
              <button id="openReport">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <p class="setting-desc" style="margin-top:8px;">
            –ï—Å–ª–∏ —Ç—ã –Ω–µ –≤ Telegram ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å <span class="muted-link" id="openDev">@Temo4ka4</span>.
          </p>
        </div>

        <p class="small" style="margin-top:12px;">
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
        </p>

      </div>
    </div>
  </div>

  <!-- Report overlay -->
  <div class="overlay" id="reportOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="–û—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ">
      <div class="sheet-head">
        <div class="sheet-title">üêû –û—Ç—á—ë—Ç</div>
        <button class="iconbtn" id="closeReport" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="sheet-body">
        <div class="field">
          <label for="repText">–û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É</label>
          <textarea id="repText" placeholder="–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? –í –∫–∞–∫–æ–π –≤–∫–ª–∞–¥–∫–µ? –ß—Ç–æ –æ–∂–∏–¥–∞–ª?"></textarea>
        </div>
        <div class="btns">
          <button class="btn primary" id="sendReport">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button class="btn" id="copyReport">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <p class="small">
          –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Telegram WebApp. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏ –Ω–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –≤—Ä—É—á–Ω—É—é.
        </p>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- LEFT -->
    <aside class="card sidebar">
      <div class="brand">
        <div class="logo" id="appLogo">DZ</div>
        <div>
          <h1>–î–æ–º–∞—à–Ω–µ–µ –ó–∞–¥–∞–Ω–∏–µ ‚Ä¢ WebApp</h1>
          <p id="who">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</p>
        </div>
      </div>

      <div class="section-title">–†–∞–∑–¥–µ–ª—ã</div>

      <button class="pill-btn" id="openSettingsBtn">
        <div class="pill" style="border:0; padding:0; background:transparent;">
          <div class="left">
            <div class="icon">‚öôÔ∏è</div>
            <div class="meta">
              <p class="t">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
              <p class="s" id="settingsSummary">–¢–µ–º–∞ ‚Ä¢ –õ–æ–≥–æ—Ç–∏–ø ‚Ä¢ –ö—ç—à</p>
            </div>
          </div>
          <div class="icon" style="width:34px;height:34px;">‚Ä∫</div>
        </div>
      </button>

      <p class="hint">
        –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å —Ç–µ–º—É, –ª–æ–≥–æ—Ç–∏–ø, —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç—å –≥–∞–ª–æ—á–∫–∏ ‚Äú—Å–¥–µ–ª–∞–Ω–æ‚Äù –∏ –ø–æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à.
      </p>

      <p class="hint" id="initHint">
        –ï—Å–ª–∏ —Ç—ã –æ—Ç–∫—Ä—ã–ª —ç—Ç–æ –Ω–µ –∏–∑ Telegram-–∫–Ω–æ–ø–∫–∏ ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚Äú–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –î–ó‚Äù) —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥—É—Ç.
      </p>
    </aside>

    <!-- RIGHT -->
    <main class="card main">
      <div class="topbar">
        <div class="title">
          <h2>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
          <p class="sub" id="subline">–õ–∏—Å—Ç–∞–π –≤–∫–ª–∞–¥–∫–∏ ‚Ä¢ –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</p>
        </div>

        <span class="chip" id="todayChip">üìÖ ‚Äî</span>
      </div>

      <!-- Tabs order: today, tomorrow, all, pick date, suggest -->
      <div class="tabs" id="tabs">
        <button class="tab" data-index="0" data-active="true">üìÖ –ù–∞ —Å–µ–≥–æ–¥–Ω—è</button>
        <button class="tab" data-index="1">üìÜ –ù–∞ –∑–∞–≤—Ç—Ä–∞</button>
        <button class="tab" data-index="2">üóÇ –í—Å—ë –î–ó</button>
        <button class="tab" data-index="3">üîé –î–ó –ø–æ –¥–∞—Ç–µ</button>
        <button class="tab" data-index="4">‚úâÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –î–ó</button>
      </div>

      <div class="pages" id="pages">
        <!-- 0: today -->
        <section class="page" data-index="0">
          <div class="page-head">
            <div>
              <h3>–ù–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
              <p class="note" id="todayNote">‚Äî</p>
            </div>
            <span class="badge warn" id="todayCount">0</span>
          </div>
          <div class="hw-list" id="todayList">
            <div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
          </div>
        </section>

        <!-- 1: tomorrow -->
        <section class="page" data-index="1">
          <div class="page-head">
            <div>
              <h3>–ù–∞ –∑–∞–≤—Ç—Ä–∞</h3>
              <p class="note" id="tomorrowNote">‚Äî</p>
            </div>
            <span class="badge warn" id="tomorrowCount">0</span>
          </div>
          <div class="hw-list" id="tomorrowList">
            <div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
          </div>
        </section>

        <!-- 2: all -->
        <section class="page" data-index="2">
          <div class="page-head">
            <div>
              <h3>–í—Å—ë –î–ó</h3>
              <p class="note">–ü–æ –¥–Ω—è–º ‚Ä¢ –ø–æ–∏—Å–∫ ‚Ä¢ –≥–∞–ª–æ—á–∫–∏</p>
            </div>
            <span class="badge" id="allCount">‚Äî</span>
          </div>

          <div class="searchbar">
            <div class="sicon">üîé</div>
            <input id="allSearch" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É –∏ —Ç–µ–∫—Å—Ç—É‚Ä¶" />
            <button class="clear" id="allSearchClear" title="–û—á–∏—Å—Ç–∏—Ç—å">‚úï</button>
          </div>

          <div class="btns">
            <button class="btn primary" id="reloadAll">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" id="jumpToday">üìÖ –ö —Å–µ–≥–æ–¥–Ω—è</button>
            <button class="btn" id="jumpTomorrow">üìÜ –ö –∑–∞–≤—Ç—Ä–∞</button>
          </div>

          <p class="small">–ù–∞–∂–º–∏ üìã –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ì–∞–ª–æ—á–∫–∏ ‚Äú—Å–¥–µ–ª–∞–Ω–æ‚Äù —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>

          <div class="hw-list" id="allList">
            <div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
          </div>
        </section>

        <!-- 3: pick date -->
        <section class="page" data-index="3">
          <div class="page-head">
            <div>
              <h3>–î–ó –ø–æ –¥–∞—Ç–µ</h3>
              <p class="note">–í—ã–±–∏—Ä–∞–π –¥–µ–Ω—å –∏ —Å–º–æ—Ç—Ä–∏</p>
            </div>
            <span class="badge" id="pickCount">‚Äî</span>
          </div>

          <div class="row">
            <div class="field">
              <label for="pickDate">–î–∞—Ç–∞</label>
              <input id="pickDate" type="date" />
            </div>
            <div class="field">
              <label>–î–µ–π—Å—Ç–≤–∏—è</label>
              <div class="btns" style="margin-top: 2px;">
                <button class="btn primary" id="pickLoad">üîç –ü–æ–∫–∞–∑–∞—Ç—å</button>
                <button class="btn" id="pickToday">üìÖ –°–µ–≥–æ–¥–Ω—è</button>
                <button class="btn" id="pickTomorrow">üìÜ –ó–∞–≤—Ç—Ä–∞</button>
              </div>
            </div>
          </div>

          <div class="hw-list" id="pickList" style="margin-top: 12px;">
            <div class="skeleton">–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –Ω–∞–∂–º–∏ ‚Äú–ü–æ–∫–∞–∑–∞—Ç—å‚Äù.</div>
          </div>
        </section>

        <!-- 4: suggest -->
        <section class="page" data-index="4">
          <div class="page-head">
            <div>
              <h3>–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –î–ó</h3>
              <p class="note">–û—Ç–ø—Ä–∞–≤–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –≤ –±–æ—Ç–∞</p>
            </div>
            <span class="badge good">‚ú®</span>
          </div>

          <div class="row">
            <div class="field">
              <label for="sDate">–î–∞—Ç–∞</label>
              <input id="sDate" type="date" />
            </div>
            <div class="field">
              <label for="sSubject">–ü—Ä–µ–¥–º–µ—Ç</label>
              <input id="sSubject" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–≥–µ–±—Ä–∞" />
            </div>
          </div>

          <div class="field" style="margin-top: 10px;">
            <label for="sText">–¢–µ–∫—Å—Ç –î–ó</label>
            <textarea id="sText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ‚Ññ123 (1-5), –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ‚Ä¶"></textarea>
          </div>

          <div class="btns">
            <button class="btn primary" id="sendSuggest">‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button class="btn" id="copySuggest">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn" id="clearSuggest">üßΩ –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <p class="small" id="suggestHint">
            –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Telegram WebApp. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –Ω–∞–∂–º–∏ ‚Äú–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å‚Äù –∏ –≤—Å—Ç–∞–≤—å –≤ —á–∞—Ç –±–æ—Ç–∞.
          </p>

          <div class="btns">
            <button class="btn" id="openBot">ü§ñ –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</button>
          </div>
        </section>

      </div>
    </main>
  </div>

  <div class="toast" id="toast">–≥–æ—Ç–æ–≤–æ</div>

  <script>
    // ================= SETTINGS KEYS =================
    const THEME_KEY = "dz_webapp_theme";             // light|dark
    const ACCENT_KEY = "dz_webapp_accent";           // standard|purple|mint
    const LOGO_KEY = "dz_webapp_logo";               // logo1|logo2|logo3|logo4|logo5 (–∏–ª–∏ —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
    const EMOJI_KEY = "dz_webapp_emoji";             // on|off
    const DONE_KEY = "dz_webapp_done";               // on|off
    const TEXT_KEY = "dz_webapp_text";               // s|m|l
    const AUTO_KEY = "dz_webapp_autorefresh";        // on|off
    const STALE_KEY = "dz_webapp_stale_min";         // number
    const CONFIRM_KEY = "dz_webapp_confirm_clear";   // on|off


    /* =========================================================
       #–í–ö–õ/–í–´–ö–õ –¢–ï–•–†–ê–ë–û–¢ (–∏—â–∏ —ç—Ç–æ—Ç –±–ª–æ–∫)
       - null  => –∞–≤—Ç–æ: –ø–æ —Å—Å—ã–ª–∫–µ/–ø–∞—Ä–∞–º–µ—Ç—Ä—É –∏–ª–∏ –ø–æ start_param
       - true  => –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã
       - false => –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã
       ========================================================= */
    const FORCE_TECHWORKS = false;

    // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–∫–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É")
    const DEV_USERNAME = "Temo4ka4";

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∫–ª—é—á–∞—é—Ç —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã –ø–æ —Å—Å—ã–ª–∫–µ:
    // ?tech=1 –∏–ª–∏ ?maintenance=1 –∏–ª–∏ ?mode=tech


    const HW_CACHE_KEY = "dz_hw_cache_v2";           // { [daysAhead]: {ts, byDay} }
    const DONE_MAP_KEY = "dz_hw_done_v2";            // { [id]: true }

    // ================= SMALL UTILS =================
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 1300);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toISODate(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }
    function formatRu(d){
      const opts = { day:"2-digit", month:"2-digit", year:"numeric" };
      return new Intl.DateTimeFormat("ru-RU", opts).format(d);
    }
    function escapeHtml(s){
      return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function prettyDateLabel(iso){
      try{
        const [y,m,d] = iso.split("-").map(Number);
        const dt = new Date(y, m-1, d);
        const weekday = new Intl.DateTimeFormat("ru-RU", { weekday:"long" }).format(dt);
        const nice = formatRu(dt);
        return `${weekday}, ${nice}`;
      }catch(e){ return iso; }
    }
    function calcDaysAhead(dateStr){
      const [y,m,d] = dateStr.split("-").map(Number);
      const target = new Date(y, m-1, d);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      return Math.floor((target - today) / 86400000);
    }
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          return ok;
        }catch(_){
          return false;
        }
      }
    }

    // ================= TELEGRAM WEBAPP =================
    const tg = window.Telegram?.WebApp || null;

    try {
  const tg = window.Telegram?.WebApp;
  if (tg && tg.sendData) {
    tg.sendData(JSON.stringify({ action: "ping_webapp", t: Date.now() }));
  }
} catch (e) {}

    function getInitData(){ return tg?.initData || ""; }
    function getUserLabel(){
      const u = tg?.initDataUnsafe?.user;
      if (!u) return "–ì–æ—Å—Ç—å";
      const name = [u.first_name, u.last_name].filter(Boolean).join(" ");
      const uname = u.username ? ("@" + u.username) : "";
      return (name || uname || ("id:" + u.id)).trim();
    }
    function setWho(){
      const who = document.getElementById("who");
      if (tg){
        who.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + getUserLabel();
        document.getElementById("initHint").style.display = "none";
      }else{
        who.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram";
      }
    }
    setWho();

    // ================= API BASE =================
    const API_BASE = "https://api.temo4ka4.ru";

    async function fetchMaybeJson(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      let data = null;
      if (text && text.trim().length){
        try { data = JSON.parse(text); } catch { data = text; }
      }
      if (!res.ok){
        const detail = (data && typeof data === "object" && (data.detail || data.error)) ? (data.detail || data.error) : null;
        const msg = detail || (typeof data === "string" ? data.slice(0, 200) : `HTTP ${res.status}`);
        throw new Error(msg);
      }
      return data;
    }

    async function apiHomeworkRange(daysAhead = 30){
      const initData = getInitData();
      if (!initData) throw new Error("no_initData");
      const url = API_BASE + "/api/homework_range?days_ahead=" + encodeURIComponent(daysAhead);
      return await fetchMaybeJson(url, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          "x-telegram-initdata": initData
        }
      });
    }

    function normalizeByDay(apiData){
  if (!apiData) return {};

  // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É
  if (typeof apiData === "string"){
    const now = new Date();
    const todayISO = toISODate(now);
    return { [todayISO]: [apiData] };
  }

  if (typeof apiData !== "object") return {};

  // –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∫–µ–π—Å: by_day —É–∂–µ –º–∞–ø–∞
  if (apiData.by_day && typeof apiData.by_day === "object" && !Array.isArray(apiData.by_day)){
    return apiData.by_day;
  }

  // –∫–µ–π—Å: days –ø—Ä–∏—Ö–æ–¥–∏—Ç –º–∞—Å—Å–∏–≤–æ–º [{day, items}]
  if (Array.isArray(apiData.days)){
    const m = {};
    for (const row of apiData.days){
      const d = row?.day;
      const items = row?.items;
      if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)){
        m[d] = Array.isArray(items) ? items : [];
      }
    }
    return m;
  }

  // –∫–µ–π—Å: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ä–∞–∑—É –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–∞–º–∏-–¥–∞—Ç–∞–º–∏
  const keys = Object.keys(apiData);
  if (keys.some(k => /^\d{4}-\d{2}-\d{2}$/.test(k))) return apiData;

  return {};
}


    // ================= SUBJECT EMOJI =================
    const SUBJECT_EMOJI = [
      { re: /–∞–ª–≥–µ–±—Ä/i, e: "üìê" },
      { re: /–≥–µ–æ–º–µ—Ç—Ä/i, e: "üìè" },
      { re: /–º–∞—Ç–µ–º/i, e: "üßÆ" },
      { re: /—Ä—É—Å/i, e: "‚úçÔ∏è" },
      { re: /–ª–∏—Ç–µ—Ä/i, e: "üìö" },
      { re: /–∞–Ω–≥–ª/i, e: "üá¨üáß" },
      { re: /–∏—Å—Ç–æ—Ä/i, e: "üèõÔ∏è" },
      { re: /–æ–±—â–µ—Å—Ç/i, e: "üë•" },
      { re: /—Ñ–∏–∑–∏–∫/i, e: "‚ö°" },
      { re: /—Ö–∏–º–∏/i, e: "üß™" },
      { re: /–±–∏–æ–ª–æ–≥/i, e: "üß¨" },
      { re: /–≥–µ–æ–≥—Ä–∞—Ñ/i, e: "üåç" },
      { re: /–∏–Ω—Ñ–æ—Ä–º/i, e: "üíª" },
      { re: /—Ç–µ—Ö–Ω–æ–ª–æ–≥/i, e: "üõ†Ô∏è" },
      { re: /–º—É–∑—ã–∫/i, e: "üéµ" },
      { re: /–∏–∑–æ|—Ä–∏—Å–æ–≤–∞–Ω/i, e: "üé®" },
      { re: /—Ñ–∏–∑–∫—É–ª—å—Ç|—Å–ø–æ—Ä—Ç/i, e: "üèÉ" },
    ];
    function emojiForSubject(subject){
      const s = (subject || "").trim();
      if (!s) return "üìù";
      const hit = SUBJECT_EMOJI.find(x => x.re.test(s));
      return hit ? hit.e : "üìù";
    }

    // ================= SETTINGS LOAD/SAVE =================
    function lsGet(key, fallback){ const v = localStorage.getItem(key); return (v===null||v===undefined||v==="") ? fallback : v; }
    function lsSet(key, value){ localStorage.setItem(key, String(value)); }

    function applyTheme(theme){
      const root = document.documentElement;
      root.dataset.theme = (theme === "dark") ? "dark" : "light";
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.setAttribute("content", theme === "dark" ? "#0b1020" : "#ffffff");
      syncSegButtons();
    }
    function applyAccent(accent){
      const root = document.documentElement;
      root.dataset.accent = (accent === "purple" || accent === "mint") ? accent : "standard";
      syncSegButtons();
    }
    function applyTextSize(v){
      const root = document.documentElement;
      root.dataset.text = (v === "s" || v === "l") ? v : "m";
      syncSegButtons();
    }

    
    function logoGlyph(key){
      // –°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏
      switch(key){
        case "book": return { type:"text", val:"üìò" };
        case "notebook": return { type:"text", val:"üóíÔ∏è" };
        case "school": return { type:"text", val:"üè´" };
        case "owl": return { type:"text", val:"ü¶â" };
        case "logo2": return { type:"img",  val:"logo2.jpg" };
        case "logo3": return { type:"img",  val:"logo3.webp" };
        case "logo4": return { type:"img",  val:"logo4.jpg" };
        case "logo5": return { type:"img",  val:"logo5.webp" };
        case "logo1":
        default: return { type:"img", val:"klasik.jpg" };
      }
    }
    function setLogoNode(el, info){
      if (!el) return;
      // –µ—Å–ª–∏ —ç—Ç–æ div.logo ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
      if (info.type === "img"){
        el.classList.add("is-img");
        el.textContent = "";
        el.innerHTML = '<img src="'+info.val+'" alt="logo">';
      } else {
        el.classList.remove("is-img");
        el.innerHTML = "";
        el.textContent = info.val;
      }
    }
    function applyLogo(key){
      const info = logoGlyph(key);
      setLogoNode(document.getElementById("appLogo"), info);
      setLogoNode(document.getElementById("splashLogo"), info);
      setLogoNode(document.getElementById("miniLogo"), info);
      syncSegButtons();
    }


    function getShowEmoji(){ return lsGet(EMOJI_KEY, "on") === "on"; }
    function getEnableDone(){ return lsGet(DONE_KEY, "on") === "on"; }
    function getAutoRefresh(){ return lsGet(AUTO_KEY, "on") === "on"; }
    function getStaleMin(){
      const v = parseInt(lsGet(STALE_KEY, "15"), 10);
      return [5,15,30,60].includes(v) ? v : 15;
    }
    function getConfirmClear(){ return lsGet(CONFIRM_KEY, "on") === "on"; }

    function syncSegButtons(){
      const theme = lsGet(THEME_KEY, "light");
      const accent = lsGet(ACCENT_KEY, "standard");
      const logo = lsGet(LOGO_KEY, "dz");
      const emoji = lsGet(EMOJI_KEY, "on");
      const done = lsGet(DONE_KEY, "on");
      const text = lsGet(TEXT_KEY, "m");
      const auto = lsGet(AUTO_KEY, "on");
      const stale = String(getStaleMin());
      const confirm = lsGet(CONFIRM_KEY, "on");

      document.querySelectorAll("#modeSeg button").forEach(b => b.dataset.on = (b.dataset.mode === theme) ? "true" : "false");
      document.querySelectorAll("#accentSeg button").forEach(b => b.dataset.on = (b.dataset.accent === accent) ? "true" : "false");
      document.querySelectorAll("#logoSeg button").forEach(b => b.dataset.on = (b.dataset.logo === logo) ? "true" : "false");
      document.querySelectorAll("#emojiSeg button").forEach(b => b.dataset.on = ((b.dataset.emoji === "on") === (emoji === "on")) ? "true" : "false");
      document.querySelectorAll("#doneSeg button").forEach(b => b.dataset.on = ((b.dataset.done === "on") === (done === "on")) ? "true" : "false");
      document.querySelectorAll("#textSeg button").forEach(b => b.dataset.on = (b.dataset.text === text) ? "true" : "false");
      document.querySelectorAll("#autoSeg button").forEach(b => b.dataset.on = ((b.dataset.auto === "on") === (auto === "on")) ? "true" : "false");
      document.querySelectorAll("#staleSeg button").forEach(b => b.dataset.on = (b.dataset.stale === stale) ? "true" : "false");
      document.querySelectorAll("#confirmSeg button").forEach(b => b.dataset.on = ((b.dataset.confirm === "on") === (confirm === "on")) ? "true" : "false");

      const sum = [];
      sum.push(theme === "dark" ? "–¢—ë–º–Ω–∞—è" : "–°–≤–µ—Ç–ª–∞—è");
      sum.push(accent === "purple" ? "–§–∏–æ–ª–µ—Ç" : (accent === "mint" ? "–ú—è—Ç–∞" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç"));
      sum.push("–¢–µ–∫—Å—Ç " + text.toUpperCase());
      document.getElementById("settingsSummary").textContent = sum.join(" ‚Ä¢ ");
    }

    function initSettings(){
      const theme = lsGet(THEME_KEY, "light");
      const accent = lsGet(ACCENT_KEY, "standard");
      const logo = lsGet(LOGO_KEY, "dz");
      const text = lsGet(TEXT_KEY, "m");

      applyTheme(theme);
      applyAccent(accent);
      applyLogo(logo);
      applyTextSize(text);

      syncSegButtons();
    }
    initSettings();

    // ================= SETTINGS OVERLAYS =================
    const settingsOverlay = document.getElementById("settingsOverlay");
    const reportOverlay = document.getElementById("reportOverlay");

    function openOverlay(overlayEl){
      overlayEl.classList.add("show");
      overlayEl.setAttribute("aria-hidden","false");
      document.body.classList.add("modal-open");
    }
    function closeOverlay(overlayEl){
      overlayEl.classList.remove("show");
      overlayEl.setAttribute("aria-hidden","true");
      if (![settingsOverlay, reportOverlay].some(o => o.classList.contains("show"))){
        document.body.classList.remove("modal-open");
      }
    }

    function showMiniSplash(text, tip){
      const el = document.getElementById("miniSplash");
      document.getElementById("miniSub").textContent = text || "–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏‚Ä¶";
      document.getElementById("miniTip").textContent = tip || "–°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å.";
      el.style.display = "grid";
      return () => { el.style.display = "none"; };
    }

    document.getElementById("openSettingsBtn").addEventListener("click", () => {
      const hide = showMiniSplash("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶", "–°–æ–≤–µ—Ç: –≤–∫–ª—é—á–∏ –≥–∞–ª–æ—á–∫–∏ ‚Äú—Å–¥–µ–ª–∞–Ω–æ‚Äù.");
      setTimeout(() => {
        hide();
        openOverlay(settingsOverlay);
      }, 3000);
    });

    document.getElementById("closeSettings").addEventListener("click", () => closeOverlay(settingsOverlay));
    settingsOverlay.addEventListener("click", (e) => { if (e.target === settingsOverlay) closeOverlay(settingsOverlay); });

    document.getElementById("openReport").addEventListener("click", () => openOverlay(reportOverlay));
    document.getElementById("closeReport").addEventListener("click", () => closeOverlay(reportOverlay));
    reportOverlay.addEventListener("click", (e) => { if (e.target === reportOverlay) closeOverlay(reportOverlay); });

    // clickable @Temo4ka4
    document.getElementById("openDev").addEventListener("click", () => {
      const url = "https://t.me/Temo4ka4";
      if (tg?.openTelegramLink) tg.openTelegramLink(url);
      else window.open(url, "_blank");
    });

    // ================= SEG BUTTONS HANDLERS =================
    document.getElementById("modeSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-mode]"); if (!b) return;
      lsSet(THEME_KEY, b.dataset.mode);
      applyTheme(b.dataset.mode);
      toast(b.dataset.mode === "dark" ? "–¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º" : "–°–≤–µ—Ç–ª—ã–π —Ä–µ–∂–∏–º");
      // –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º, —á—Ç–æ–±—ã –ª–∏–Ω–∏–∏/–≤–∏–¥ –±—ã–ª –Ω–æ—Ä–º
      rerenderAllVisible();
    });

    document.getElementById("accentSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-accent]"); if (!b) return;
      lsSet(ACCENT_KEY, b.dataset.accent);
      applyAccent(b.dataset.accent);
      toast("–¢–µ–º–∞: " + (b.dataset.accent === "purple" ? "–§–∏–æ–ª–µ—Ç" : b.dataset.accent === "mint" ? "–ú—è—Ç–∞" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç"));
    });

    document.getElementById("logoSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-logo]"); if (!b) return;
      lsSet(LOGO_KEY, b.dataset.logo);
      applyLogo(b.dataset.logo);
      toast("–õ–æ–≥–æ—Ç–∏–ø –∏–∑–º–µ–Ω—ë–Ω");
    });

    document.getElementById("emojiSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-emoji]"); if (!b) return;
      lsSet(EMOJI_KEY, b.dataset.emoji);
      syncSegButtons();
      toast(b.dataset.emoji === "on" ? "–≠–º–æ–¥–∑–∏ –≤–∫–ª—é—á–µ–Ω—ã" : "–≠–º–æ–¥–∑–∏ —Å–∫—Ä—ã—Ç—ã");
      rerenderAllVisible();
    });

    document.getElementById("doneSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-done]"); if (!b) return;
      lsSet(DONE_KEY, b.dataset.done === "on" ? "on" : "off");
      syncSegButtons();
      toast(b.dataset.done === "on" ? "–ì–∞–ª–æ—á–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã" : "–ì–∞–ª–æ—á–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã");
      rerenderAllVisible();
    });

    document.getElementById("textSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-text]"); if (!b) return;
      lsSet(TEXT_KEY, b.dataset.text);
      applyTextSize(b.dataset.text);
      toast("–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: " + b.dataset.text.toUpperCase());
    });

    document.getElementById("autoSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-auto]"); if (!b) return;
      lsSet(AUTO_KEY, b.dataset.auto === "on" ? "on" : "off");
      syncSegButtons();
      toast(b.dataset.auto === "on" ? "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–∫–ª" : "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í—ã–∫–ª");
    });

    document.getElementById("staleSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-stale]"); if (!b) return;
      lsSet(STALE_KEY, b.dataset.stale);
      syncSegButtons();
      toast("–£—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏–µ: " + b.dataset.stale + " –º–∏–Ω");
    });

    document.getElementById("confirmSeg").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-confirm]"); if (!b) return;
      lsSet(CONFIRM_KEY, b.dataset.confirm === "on" ? "on" : "off");
      syncSegButtons();
      toast(b.dataset.confirm === "on" ? "–ë—É–¥–µ–º —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å" : "–ë–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
    });

    // ================= CACHING =================
    function readHwCache(){
      try{
        const raw = localStorage.getItem(HW_CACHE_KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        return {};
      }
    }
    function writeHwCache(cacheObj){
      try{ localStorage.setItem(HW_CACHE_KEY, JSON.stringify(cacheObj)); }catch(e){}
    }
    function getHwCache(daysAhead){
      const all = readHwCache();
      return all[String(daysAhead)] || null;
    }
    function setHwCache(daysAhead, byDay){
      const all = readHwCache();
      all[String(daysAhead)] = { ts: Date.now(), byDay };
      writeHwCache(all);
    }
    function clearHwCache(){
      try{ localStorage.removeItem(HW_CACHE_KEY); }catch(e){}
    }

    // ================= DONE MAP =================
    function readDoneMap(){
      try{
        const raw = localStorage.getItem(DONE_MAP_KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function writeDoneMap(m){
      try{ localStorage.setItem(DONE_MAP_KEY, JSON.stringify(m)); }catch(e){}
    }
    function isDone(id){
      const m = readDoneMap();
      return !!m[id];
    }
    function setDone(id, value){
      const m = readDoneMap();
      if (value) m[id] = true;
      else delete m[id];
      writeDoneMap(m);
    }

    // ================= SPLASH TEXT ROTATION =================
    const splashLines = [
      "–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–º–∞—à–∫—É‚Ä¶",
      "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è‚Ä¶",
      "–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–ª–∞—Å—Å—É‚Ä¶",
      "–°–æ–±–∏—Ä–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º‚Ä¶"
    ];
    const splashTips = [
      "–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏ üìã, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –î–ó.",
      "–°–æ–≤–µ—Ç: –≤ ‚Äú–í—Å—ë –î–ó‚Äù –µ—Å—Ç—å –ø–æ–∏—Å–∫ üîé.",
      "–°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.",
      "–°–æ–≤–µ—Ç: –≤–∫–ª—é—á–∏ –≥–∞–ª–æ—á–∫–∏ ‚Äú—Å–¥–µ–ª–∞–Ω–æ‚Äù."
    ];
    function setSplashText(){
      document.getElementById("splashSub").textContent = splashLines[Math.floor(Math.random()*splashLines.length)];
      document.getElementById("splashTip").textContent = splashTips[Math.floor(Math.random()*splashTips.length)];
    }
    setSplashText();

    // ================= DATA LOADING =================
    const now = new Date();
    const todayISO = toISODate(now);
    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    const tomorrowISO = toISODate(tomorrow);

    document.getElementById("todayChip").textContent = "üìÖ " + formatRu(now);
    document.getElementById("tomorrowNote").textContent = prettyDateLabel(tomorrowISO);
    document.getElementById("todayNote").textContent = prettyDateLabel(todayISO);

    const pickDateEl = document.getElementById("pickDate");
    const sDateEl = document.getElementById("sDate");
    pickDateEl.value = todayISO;
    sDateEl.value = todayISO;

    let cacheByDayMem = null;
    let cacheDaysAheadMem = null;

    async function ensureCache(daysAhead){
      // memory cache
      if (cacheByDayMem && cacheDaysAheadMem === daysAhead) return cacheByDayMem;

      const auto = getAutoRefresh();
      const staleMin = getStaleMin();

      // localStorage cache
      const cached = getHwCache(daysAhead);
      const isStale = cached ? ((Date.now() - cached.ts) > staleMin*60*1000) : true;

      if (cached && (!auto || !isStale)){
        cacheByDayMem = cached.byDay;
        cacheDaysAheadMem = daysAhead;
        return cached.byDay;
      }

      // fetch
      const data = await apiHomeworkRange(daysAhead);
      const byDay = normalizeByDay(data);
      cacheByDayMem = byDay;
      cacheDaysAheadMem = daysAhead;
      setHwCache(daysAhead, byDay);
      return byDay;
    }

    // store for copy/search
    const hwStore = {}; // id -> {date, subject, body}

    function hwId(dateISO, subject, body){
      const s = (dateISO||"") + "|" + (subject||"") + "|" + (body||"");
      // djb2
      let h = 5381;
      for (let i=0;i<s.length;i++) h = ((h << 5) + h) + s.charCodeAt(i);
      return "h" + (h >>> 0).toString(16);
    }

    function extractSubjectAndBody(line){
      const obj = (typeof line === "object" && line) ? line : null;
      const rawText = (typeof line === "string") ? line : (obj?.text ?? "");
      let subject = (obj?.subject || "").trim();
      let body = rawText;

      if (!subject) {
        const mm = rawText.match(/^(.{1,50}?)\s*[‚Äî-]\s*(.+)$/);
        if (mm) {
          subject = (mm[1] || "").trim();
          body = (mm[2] || "").trim();
        }
      }
      if (!subject) subject = "–î–æ–º–∞—à–∫–∞";
      return { subject, body };
    }

    function buildTitle(subject){
      if (!getShowEmoji()) return subject;
      const em = emojiForSubject(subject);
      return `${em} ${subject}`;
    }

    function cardHtml(dateISO, line){
      const { subject, body } = extractSubjectAndBody(line);
      const id = hwId(dateISO, subject, body);
      hwStore[id] = { date: dateISO, subject, body };

      const enableDone = getEnableDone();
      const done = enableDone ? isDone(id) : false;
      const title = buildTitle(subject);

      return `
        <article class="hw-card ${done ? "done" : ""}" data-id="${id}">
          <div class="hw-top">
            <div>
              <p class="hw-title">${escapeHtml(title)}</p>
              <p class="hw-date">${escapeHtml(dateISO)}</p>
            </div>
            <div class="hw-actions">
              ${enableDone ? `<label class="checkwrap" title="–°–¥–µ–ª–∞–Ω–æ">
                <input type="checkbox" class="doneCheck" data-id="${id}" ${done ? "checked" : ""} />
              </label>` : ``}
              <button class="iconbtn" data-copy="${id}" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
            </div>
          </div>
          <p class="hw-text">${escapeHtml(body)}</p>
        </article>
      `;
    }

    function renderCards(listEl, dateISO, items){
      listEl.innerHTML = "";
      if (!items || !items.length){
        listEl.innerHTML = `<div class="skeleton">–ù–∞ <b>${escapeHtml(dateISO)}</b> –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–º–∞—à–∫–∏.</div>`;
        return 0;
      }
      listEl.innerHTML = items.map(line => cardHtml(dateISO, line)).join("");
      return items.length;
    }

    function renderGroupedAll(listEl, byDay){
      listEl.innerHTML = "";
      const dates = Object.keys(byDay).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
      if (!dates.length){
        listEl.innerHTML = `<div class="skeleton">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –î–ó –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ.</div>`;
        return 0;
      }
      let total = 0;

      const html = dates.map((d) => {
        const items = byDay[d] || [];
        const arr = Array.isArray(items) ? items : [];
        total += arr.length;

        const inner = arr.length
          ? arr.map(line => `<div style="margin-top:10px;">${cardHtml(d, line)}</div>`).join("")
          : `<div class="skeleton" style="margin-top:10px;">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>`;

        return `
          <section style="margin-top:12px;" data-day="${d}" id="day-${d}">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
              <div style="display:flex;flex-direction:column;">
                <div style="font-weight:900; font-size:calc(14px * var(--scale)); letter-spacing:-.2px;">${escapeHtml(d)}</div>
                <div style="font-size:calc(12px * var(--scale));color:var(--muted); margin-top:2px;">${escapeHtml(prettyDateLabel(d))}</div>
              </div>
              <span class="badge ${arr.length ? "warn" : ""}">${arr.length}</span>
            </div>
            ${inner}
          </section>
        `;
      }).join("");

      listEl.innerHTML = html;
      return total;
    }

    // ================= TABS + PAGES (scroll sync) =================
    const pagesEl = document.getElementById("pages");
    const tabBtns = Array.from(document.querySelectorAll(".tab"));

    function setActiveTab(i){
      tabBtns.forEach(b => b.dataset.active = (Number(b.dataset.index) === i) ? "true" : "false");
    }
    function scrollToPage(i){
      const w = pagesEl.clientWidth;
      pagesEl.scrollTo({ left: i * w, behavior: "smooth" });
      setActiveTab(i);
      const btn = tabBtns.find(b => Number(b.dataset.index) === i);
      if (btn) btn.scrollIntoView({ behavior:"smooth", inline:"center", block:"nearest" });
    }

    tabBtns.forEach(btn => {
      btn.addEventListener("click", async () => {
        const idx = Number(btn.dataset.index);
        scrollToPage(idx);
        if (idx === 0) await loadToday();
        if (idx === 1) await loadTomorrow();
        if (idx === 2) await loadAll();
      });
    });

    let scrollTimer = null;
    pagesEl.addEventListener("scroll", () => {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => {
        const i = Math.round(pagesEl.scrollLeft / pagesEl.clientWidth);
        setActiveTab(i);
        const btn = tabBtns.find(b => Number(b.dataset.index) === i);
        if (btn) btn.scrollIntoView({ behavior:"smooth", inline:"center", block:"nearest" });
      }, 80);
    });

    // ================= LOADERS =================
    async function loadToday(){
      const todayList = document.getElementById("todayList");
      todayList.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
      try{
        const byDay = await ensureCache(0);
        const c = renderCards(todayList, todayISO, byDay[todayISO] || []);
        document.getElementById("todayCount").textContent = String(c);
      }catch(e){
        const msg = e?.message ? e.message : String(e);
        const pretty = (msg === "no_initData") ? "–ù–µ—Ç initData. –û—Ç–∫—Ä–æ–π –∏–∑ Telegram-–∫–Ω–æ–ø–∫–∏." : ("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + msg);
        todayList.innerHTML = `<div class="skeleton">${escapeHtml(pretty)}</div>`;
        document.getElementById("todayCount").textContent = "0";
      }
    }

    async function loadTomorrow(){
      const tomorrowList = document.getElementById("tomorrowList");
      tomorrowList.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
      try{
        const byDay = await ensureCache(1);
        const c = renderCards(tomorrowList, tomorrowISO, byDay[tomorrowISO] || []);
        document.getElementById("tomorrowCount").textContent = String(c);
      }catch(e){
        const msg = e?.message ? e.message : String(e);
        const pretty = (msg === "no_initData") ? "–ù–µ—Ç initData. –û—Ç–∫—Ä–æ–π –∏–∑ Telegram-–∫–Ω–æ–ø–∫–∏." : ("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + msg);
        tomorrowList.innerHTML = `<div class="skeleton">${escapeHtml(pretty)}</div>`;
        document.getElementById("tomorrowCount").textContent = "0";
      }
    }

  async function apiProposeHW({ day, subject, text }){
    const initData = getInitData();
    if (!initData) throw new Error("no_initData");

    return await fetchMaybeJson(API_BASE + "/api/propose_hw", {
     method: "POST",
     headers: {
      "Accept": "application/json",
      "Content-Type": "application/json",
      "x-telegram-initdata": initData
    },
    body: JSON.stringify({ day, subject, text })
  });
}

async function apiReportIssue({ title, details, page }){
  const initData = getInitData();
  if (!initData) throw new Error("no_initData");

  return await fetchMaybeJson(API_BASE + "/api/report_issue", {
    method: "POST",
    headers: {
      "Accept": "application/json",
      "Content-Type": "application/json",
      "x-telegram-initdata": initData
    },
    body: JSON.stringify({ title, details, page })
  });
}

    async function loadAll(){
      const allList = document.getElementById("allList");
      allList.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
      try{
        const byDay = await ensureCache(60);
        const total = renderGroupedAll(allList, byDay);
        document.getElementById("allCount").textContent = String(total);
        filterAll(document.getElementById("allSearch").value || "");
      }catch(e){
        const msg = e?.message ? e.message : String(e);
        const pretty = (msg === "no_initData") ? "–ù–µ—Ç initData. –û—Ç–∫—Ä–æ–π –∏–∑ Telegram-–∫–Ω–æ–ø–∫–∏." : ("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + msg);
        allList.innerHTML = `<div class="skeleton">${escapeHtml(pretty)}</div>`;
        document.getElementById("allCount").textContent = "‚Äî";
      }
    }

    async function loadPick(dateISO){
      const pickList = document.getElementById("pickList");
      pickList.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
      try{
        const days = calcDaysAhead(dateISO);
        const byDay = await ensureCache(Math.max(0, days));
        const items = byDay[dateISO] || [];
        const cnt = renderCards(pickList, dateISO, items);
        document.getElementById("pickCount").textContent = String(cnt);
      }catch(e){
        const msg = e?.message ? e.message : String(e);
        const pretty = (msg === "no_initData") ? "–ù–µ—Ç initData. –û—Ç–∫—Ä–æ–π –∏–∑ Telegram-–∫–Ω–æ–ø–∫–∏." : ("–û—à–∏–±–∫–∞: " + msg);
        pickList.innerHTML = `<div class="skeleton">${escapeHtml(pretty)}</div>`;
        document.getElementById("pickCount").textContent = "‚Äî";
      }
    }

    // pick buttons
    document.getElementById("pickLoad").addEventListener("click", () => loadPick(pickDateEl.value));
    document.getElementById("pickToday").addEventListener("click", () => { pickDateEl.value = todayISO; loadPick(todayISO); });
    document.getElementById("pickTomorrow").addEventListener("click", () => { pickDateEl.value = tomorrowISO; loadPick(tomorrowISO); });

    // all buttons
    document.getElementById("reloadAll").addEventListener("click", () => loadAll());

    function jumpToDateInAll(dateISO){
      const el = document.getElementById("day-" + dateISO);
      if (el) el.scrollIntoView({ behavior:"smooth", block:"start" });
      else toast("–î–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ");
    }
    document.getElementById("jumpToday").addEventListener("click", async () => {
      await loadAll();
      jumpToDateInAll(todayISO);
    });
    document.getElementById("jumpTomorrow").addEventListener("click", async () => {
      await loadAll();
      jumpToDateInAll(tomorrowISO);
    });

    // ================= SEARCH (ALL) =================
    function filterAll(q){
      const query = (q || "").trim().toLowerCase();
      const allList = document.getElementById("allList");
      const sections = Array.from(allList.querySelectorAll("section[data-day]"));

      sections.forEach(sec => {
        const cards = Array.from(sec.querySelectorAll(".hw-card[data-id]"));
        let visible = 0;
        cards.forEach(card => {
          const id = card.getAttribute("data-id");
          const it = hwStore[id];
          const text = (it ? (it.subject + " " + it.body) : "").toLowerCase();
          const ok = !query || text.includes(query);
          card.style.display = ok ? "" : "none";
          if (ok) visible++;
        });
        sec.style.display = (visible > 0 || !query) ? "" : "none";
      });
    }

    document.getElementById("allSearch").addEventListener("input", (e) => filterAll(e.target.value));
    document.getElementById("allSearchClear").addEventListener("click", () => {
      const inp = document.getElementById("allSearch");
      inp.value = "";
      filterAll("");
      inp.focus();
    });

    // ================= CARD ACTIONS (DONE + COPY) =================
    document.addEventListener("change", (e) => {
      const cb = e.target.closest(".doneCheck");
      if (!cb) return;
      const id = cb.dataset.id;
      setDone(id, cb.checked);
      const card = document.querySelector(`.hw-card[data-id="${id}"]`);
      if (card){
        if (cb.checked) card.classList.add("done");
        else card.classList.remove("done");
      }
      toast(cb.checked ? "–û—Ç–º–µ—á–µ–Ω–æ —Å–¥–µ–ª–∞–Ω–Ω—ã–º" : "–°–Ω—è—Ç–æ");
    });

    document.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-copy]");
      if (!btn) return;
      const id = btn.getAttribute("data-copy");
      const it = hwStore[id];
      if (!it) return;

      const showEmoji = getShowEmoji();
      const title = showEmoji ? (emojiForSubject(it.subject) + " " + it.subject) : it.subject;
      const text = `${it.date}\n${title} ‚Äî ${it.body}`;

      const ok = await copyToClipboard(text);
      toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ üìã" : "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });

    function rerenderAllVisible(){
      // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–ø–∏—Å–∫–∏ (–≤ –ø–∞–º—è—Ç–∏/–∫—ç—à–µ –≤—Å—ë —É–∂–µ –µ—Å—Ç—å)
      loadToday();
      loadTomorrow();
      // all ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç/–∑–∞–≥—Ä—É–∂–µ–Ω
      const allList = document.getElementById("allList");
      if (allList && allList.querySelector("section[data-day]")) loadAll();
      // pick ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    }

    // ================= CLEAR CACHE =================
    document.getElementById("clearCacheBtn").addEventListener("click", () => {
      const needConfirm = getConfirmClear();
      if (needConfirm){
        const ok = confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à? –î–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–Ω—É—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏.");
        if (!ok) return;
      }
      clearHwCache();
      cacheByDayMem = null;
      cacheDaysAheadMem = null;
      toast("–ö—ç—à –æ—á–∏—â–µ–Ω");
    });

    // ================= REPORT =================
    document.getElementById("copyReport").addEventListener("click", async () => {
      const t = (document.getElementById("repText").value || "").trim();
      if (!t) return toast("–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç");
      const ok = await copyToClipboard("üêû –û—à–∏–±–∫–∞ –≤ WebApp:\n" + t);
      toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ" : "–ù–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å");
    });

    document.getElementById("sendReport").addEventListener("click", async () => {
      const t = (document.getElementById("repText").value || "").trim();
      if (!t) return toast("–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç");

     const payload = {
  action: "report_issue",
  title: "–û—à–∏–±–∫–∞ –≤ WebApp",
  details: t,
  page: document.querySelector(".tab[data-active='true']")?.textContent?.trim() || ""
};


      if (tg && tg.sendData){
        tg.sendData(JSON.stringify(payload));
        toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
        document.getElementById("repText").value = "";
        closeOverlay(reportOverlay);
      }else{
        const ok = await copyToClipboard("üêû –û—à–∏–±–∫–∞ –≤ WebApp:\n" + t);
        toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ (–≤–Ω–µ Telegram)" : "–í–Ω–µ Telegram");
      }
    });

    // ================= SUGGEST =================
    function buildSuggestPayload(){
      return {
        action: "propose_hw",
        day: payload.date,  
        subject: (document.getElementById("sSubject").value || "").trim(),
        text: (document.getElementById("sText").value || "").trim()
      };
    }

    document.getElementById("sendSuggest").addEventListener("click", () => {
      const payload = buildSuggestPayload();

      if (!payload.subject || !payload.text){
        toast("–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–µ–¥–º–µ—Ç –∏ —Ç–µ–∫—Å—Ç");
        return;
      }

      if (tg && tg.sendData){
        tg.sendData(JSON.stringify(payload));
        toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç–∞");
      }else{
        toast("–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram");
      }
    });

    document.getElementById("copySuggest").addEventListener("click", async () => {
      const payload = buildSuggestPayload();
      if (!payload.subject || !payload.text){
        toast("–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–µ–¥–º–µ—Ç –∏ —Ç–µ–∫—Å—Ç");
        return;
      }
      const text = `üì© –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –î–ó\nüìÖ ${payload.date}\nüìö ${payload.subject}\n\n${payload.text}`;
      const ok = await copyToClipboard(text);
      toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ" : "–ù–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å");
    });

    document.getElementById("clearSuggest").addEventListener("click", () => {
      document.getElementById("sSubject").value = "";
      document.getElementById("sText").value = "";
      toast("–û—á–∏—â–µ–Ω–æ");
    });

    document.getElementById("openBot").addEventListener("click", () => {
      const url = "https://t.me/Temo4ka4bot";
      if (tg?.openTelegramLink) tg.openTelegramLink(url);
      else window.open(url, "_blank");
    });

    // ================= INIT SPLASH =================
    function hideSplash(){
      const splash = document.getElementById("splash");
      if (!splash) return;
      splash.classList.add("hide");
      setTimeout(() => splash.remove(), 350);
    }

    // ================= INIT =================
    
    function openDevChat(){
      const url = "https://t.me/" + DEV_USERNAME;
      if (tg && tg.openTelegramLink) tg.openTelegramLink(url);
      else window.open(url, "_blank");
    }

    function setTechworks(on, title, msg){
      const o = document.getElementById("techOverlay");
      if (!o) return;
      if (on){
        document.getElementById("techTitle").textContent = title || "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã";
        document.getElementById("techHead").textContent = "–°–µ—Ä–≤–∏—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è";
        document.getElementById("techMsg").textContent = msg || "–°–µ–π—á–∞—Å –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å—ã. –î–æ–º–∞—à–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ.";
        o.classList.add("on");
        o.setAttribute("aria-hidden","false");
        document.documentElement.style.overflow = "hidden";
        document.body.style.overflow = "hidden";
      } else {
        o.classList.remove("on");
        o.setAttribute("aria-hidden","true");
        document.documentElement.style.overflow = "";
        document.body.style.overflow = "";
      }
    }

    function shouldShowTechworks(){
      if (FORCE_TECHWORKS === true) return true;
      if (FORCE_TECHWORKS === false) return false;

      const sp = new URLSearchParams(location.search);
      if (sp.get("tech") === "1" || sp.get("maintenance") === "1") return true;
      if ((sp.get("mode") || "").toLowerCase() === "tech") return true;

      // Telegram start_param (–µ—Å–ª–∏ —Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å WebApp —á–µ—Ä–µ–∑ bot.startApp —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º)
      try{
        const p = (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) ? String(tg.initDataUnsafe.start_param) : "";
        if (p.toLowerCase().includes("tech") || p.toLowerCase().includes("maintenance")) return true;
      }catch(e){}

      return false;
    }

    // –ö–Ω–æ–ø–∫–∏ —Ç–µ—Ö—Ä–∞–±–æ—Ç
    (function bindTechButtons(){
      const r = document.getElementById("techRetry");
      const x = document.getElementById("techExit");
      const d = document.getElementById("techDev");
      if (r) r.addEventListener("click", () => location.reload());
      if (x) x.addEventListener("click", () => { try{ if (tg && tg.close) tg.close(); }catch(e){} window.close(); });
      if (d) d.addEventListener("click", openDevChat);
    })();


    (async () => {
      if (shouldShowTechworks()){ setTechworks(true); return; }
      if (tg){
        try{ tg.ready(); tg.expand(); }catch(e){}
      }

      const t0 = Date.now();
      const MIN_MS = 3000;

      // —Å—Ç–∞—Ä—Ç—É–µ–º —Å "–ù–∞ —Å–µ–≥–æ–¥–Ω—è"
      await loadToday();
      await loadTomorrow();
      await loadPick(todayISO);

      const spent = Date.now() - t0;
      const left = Math.max(0, MIN_MS - spent);
      setTimeout(hideSplash, left);
    })();
  </script>
</body>
</html>
