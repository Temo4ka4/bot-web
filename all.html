<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–í—Å–µ –î–ó</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    :root{--bg:#fff;--card:#fff;--text:#111;--muted:#666;--shadow:0 10px 25px rgba(0,0,0,.08);--border:#e9e9ef}
    [data-theme="dark"]{--bg:#0f1115;--card:#141824;--text:#f2f3f5;--muted:#a6adbb;--shadow:0 10px 25px rgba(0,0,0,.35);--border:#262b3a}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .top{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));backdrop-filter:saturate(1.2) blur(6px);padding:14px 16px 10px;display:flex;align-items:center;gap:12px}
    .title{font-weight:900;font-size:18px}
    .sp{flex:1}
    .toggle{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted);user-select:none}
    .switch{width:44px;height:24px;border-radius:999px;background:var(--border);position:relative;cursor:pointer}
    .knob{width:18px;height:18px;border-radius:50%;background:var(--card);position:absolute;top:3px;left:3px;box-shadow:var(--shadow);transition:.18s}
    [data-theme="dark"] .knob{left:23px}
    .wrap{padding:10px 16px 18px;max-width:820px;margin:0 auto}
    .meta{color:var(--muted);font-size:13px;margin:2px 0 14px}
    .day{margin-top:16px;font-weight:900}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:10px 0}
    .subj{font-weight:900}
    .txt{white-space:pre-wrap;margin-top:6px;line-height:1.35}
    .hint{margin-top:10px;color:var(--muted);font-size:12px}
    .empty{padding:22px;border:1px dashed var(--border);border-radius:18px;color:var(--muted);text-align:center}
    .mono{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;margin-top:10px}
  </style>
</head>
<body>
  <div class="top">
    <div class="title">üóÇ –í—Å–µ –î–ó</div>
    <div class="sp"></div>
    <div class="toggle" id="toggle"><span>–¢–µ–º–∞</span><div class="switch"><div class="knob"></div></div></div>
  </div>

  <div class="wrap">
    <div class="meta">–ü–æ–∫–∞–∑—ã–≤–∞—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –î–ó –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π</div>
    <div id="list"></div>
  </div>

  <script>
    const API_BASE = "https://api.temo4ka4.ru";
    const DAYS_AHEAD = 30;

    const tg = window.Telegram?.WebApp || null;
    if (tg) { tg.ready(); tg.expand(); }

    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
    }
    setTheme(localStorage.getItem("theme")==="dark" ? "dark" : "light");
    document.getElementById("toggle").onclick = () => {
      const cur = document.documentElement.getAttribute("data-theme");
      setTheme(cur === "light" ? "dark" : "light");
    };

    function esc(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function showMessage(title, text, debug){
      document.getElementById("list").innerHTML =
        `<div class="empty"><b>${esc(title)}</b><br/>${esc(text)}${debug?`<div class="mono">${esc(debug)}</div>`:""}</div>`;
    }

    function render(days){
      const root = document.getElementById("list");
      root.innerHTML = "";
      if (!days || !days.length){
        root.innerHTML = `<div class="empty">–í –±–ª–∏–∂–∞–π—à–∏–µ ${DAYS_AHEAD} –¥–Ω–µ–π –î–ó –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
        return;
      }
      for (const d of days){
        root.insertAdjacentHTML("beforeend", `<div class="day">üìÖ ${esc(d.day)}</div>`);
        for (const it of (d.items || [])){
          const subj = (it.subject && it.subject.trim()) ? it.subject.trim() : "–û–±—â–µ–µ";
          const files = (it.files_count > 0)
            ? `<div class="hint">üìé –ï—Å—Ç—å —Ñ–∞–π–ª—ã (${it.files_count}). –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ—Ç–∫—Ä–æ–π –î–ó –≤ –±–æ—Ç–µ.</div>`
            : "";
          root.insertAdjacentHTML("beforeend", `
            <div class="card">
              <div class="subj">${esc(subj)} ‚Äî</div>
              <div class="txt">${esc(it.text || "‚Äî")}</div>
              ${files}
            </div>
          `);
        }
      }
    }

    async function waitInitData(){
      for (let i=0;i<20;i++){
        const v = tg?.initData || "";
        if (v.length > 0) return v;
        await new Promise(r=>setTimeout(r,100));
      }
      return "";
    }

    async function apiGet(path, initData){
      const r = await fetch(API_BASE + path, { headers: { "X-Telegram-InitData": initData } });
      const txt = await r.text();
      if (!r.ok) throw new Error(txt || ("HTTP " + r.status));
      return JSON.parse(txt);
    }

    (async ()=>{
      if (!tg){
        showMessage("‚ö†Ô∏è –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram", "–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–∑ –±–æ—Ç–∞.");
        return;
      }

      const initData = await waitInitData();
      if (!initData){
        showMessage(
          "‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram",
          "initData –ø—É—Å—Ç–∞—è. –ó–Ω–∞—á–∏—Ç –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã–ª–∞ –Ω–µ WebApp-–∫–æ–Ω—Ç–µ–∫—Å—Ç.",
          "initData len = 0\nhref = " + location.href
        );
        return;
      }

      try{
        const data = await apiGet(`/api/homework_range?days_ahead=${DAYS_AHEAD}`, initData);
        if (data?.error === "no_class"){
          showMessage("‚ÑπÔ∏è –¢—ã –Ω–µ –≤ –∫–ª–∞—Å—Å–µ", "–í—Å—Ç—É–ø–∏ –≤ –∫–ª–∞—Å—Å –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –î–ó.");
          return;
        }
        render(data.days || []);
      }catch(e){
        showMessage("üîå –°–µ—Ä–≤–µ—Ä/API –æ—à–∏–±–∫–∞", "API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É.", String(e));
      }
    })();
  </script>
</body>
</html>
