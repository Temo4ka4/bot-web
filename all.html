<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WebApp debug</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px}
    pre{white-space:pre-wrap;background:#f4f4f6;padding:12px;border-radius:12px}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;margin-right:8px}
    .row{margin:12px 0}
  </style>
</head>
<body>
  <h3>WebApp debug</h3>
  <div class="row">
    <button id="btnReload">Обновить данные</button>
    <button id="btnExpand">tg.expand()</button>
  </div>
  <pre id="out">loading...</pre>

<script>
const API = "https://api.temo4ka4.ru";

function safeJson(obj){
  try { return JSON.stringify(obj, null, 2); }
  catch(e){ return String(obj); }
}

async function check(){
  const tg = window.Telegram?.WebApp || null;

  // если tg есть — попросим Telegram “инициализироваться”
  try { tg?.ready(); } catch(e){}
  try { tg?.expand(); } catch(e){}

  const info = {
    hasTelegramWebApp: !!tg,
    initDataLen: tg ? (tg.initData || "").length : 0,
    initDataUnsafeUser: tg?.initDataUnsafe?.user || null,
    platform: tg?.platform || null,
    version: tg?.version || null,
    href: location.href
  };

  let health = null;
  try {
    const r = await fetch(API + "/health", { method: "GET", mode: "cors" });
    const text = await r.text();
    health = {
      ok: r.ok,
      status: r.status,
      text: text
    };
  } catch (e) {
    health = { error: String(e) };
  }

  document.getElementById("out").textContent = safeJson({info, health});
}

document.getElementById("btnReload").onclick = check;
document.getElementById("btnExpand").onclick = () => {
  const tg = window.Telegram?.WebApp || null;
  try { tg?.expand(); } catch(e){}
  check();
};

check();
</script>
</body>
</html>
