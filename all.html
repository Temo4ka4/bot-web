<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–í—Å–µ –î–ó</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e9e9ef;
      --shadow:0 10px 25px rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#0f1115;
      --card:#141824;
      --text:#f2f3f5;
      --muted:#a6adbb;
      --border:#262b3a;
      --shadow:0 10px 25px rgba(0,0,0,.35);
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    .top{
      position:sticky;
      top:0;
      background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));
      backdrop-filter:blur(6px);
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .title{font-weight:900;font-size:18px}
    .sp{flex:1}

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .switch{
      width:42px;height:22px;
      background:var(--border);
      border-radius:999px;
      position:relative;
    }
    .knob{
      width:16px;height:16px;
      background:var(--card);
      border-radius:50%;
      position:absolute;
      top:3px;left:3px;
      transition:.2s;
      box-shadow:var(--shadow);
    }
    [data-theme="dark"] .knob{left:23px}

    .wrap{padding:12px 16px;max-width:820px;margin:0 auto}
    .meta{color:var(--muted);font-size:13px;margin-bottom:12px}

    .day{margin-top:16px;font-weight:900}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      margin-top:10px;
      box-shadow:var(--shadow);
    }
    .subj{font-weight:900}
    .txt{margin-top:6px;white-space:pre-wrap;line-height:1.35}
    .hint{margin-top:8px;font-size:12px;color:var(--muted)}

    .empty{
      padding:22px;
      border:1px dashed var(--border);
      border-radius:18px;
      text-align:center;
      color:var(--muted);
    }
  </style>
</head>
<body>

<div class="top">
  <div class="title">üóÇ –í—Å–µ –î–ó</div>
  <div class="sp"></div>
  <div class="toggle" id="toggle">
    –¢–µ–º–∞
    <div class="switch"><div class="knob"></div></div>
  </div>
</div>

<div class="wrap">
  <div class="meta">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π</div>
  <div id="list"></div>
</div>

<script>
const API_BASE = "https://api.temo4ka4.ru";
const DAYS_AHEAD = 30;

const tg = window.Telegram?.WebApp || null;
if (tg) {
  tg.ready();
  tg.expand();
}

// --- –¢–ï–ú–ê ---
function setTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem("theme", t);
}
setTheme(localStorage.getItem("theme")==="dark" ? "dark" : "light");
document.getElementById("toggle").onclick = () => {
  setTheme(
    document.documentElement.getAttribute("data-theme")==="dark"
      ? "light" : "dark"
  );
};

// --- –£–¢–ò–õ–ò–¢–´ ---
function esc(s){
  return (s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function showMessage(title, text){
  document.getElementById("list").innerHTML =
    `<div class="empty"><b>${esc(title)}</b><br>${esc(text)}</div>`;
}

function render(days){
  const root = document.getElementById("list");
  root.innerHTML = "";

  if (!days || !days.length){
    root.innerHTML =
      `<div class="empty">–í –±–ª–∏–∂–∞–π—à–∏–µ ${DAYS_AHEAD} –¥–Ω–µ–π –î–ó –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
    return;
  }

  for (const d of days){
    root.insertAdjacentHTML(
      "beforeend",
      `<div class="day">üìÖ ${esc(d.day)}</div>`
    );

    for (const it of (d.items || [])){
      root.insertAdjacentHTML(
        "beforeend",
        `<div class="card">
          <div class="subj">${esc(it.subject || "–û–±—â–µ–µ")} ‚Äî</div>
          <div class="txt">${esc(it.text || "‚Äî")}</div>
          ${it.files_count>0
            ? `<div class="hint">üìé –ï—Å—Ç—å —Ñ–∞–π–ª—ã (${it.files_count})</div>`
            : ""
          }
        </div>`
      );
    }
  }
}

// --- –ó–ê–ì–†–£–ó–ö–ê ---
(async ()=>{
  if (!tg){
    showMessage("‚ö†Ô∏è –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram",
      "–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –±–æ—Ç–∞.");
    return;
  }

  const initData = tg.initData || "";
  if (!initData){
    showMessage("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram",
      "–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–Ω–æ–ø–∫–æ–π WebApp –∏–∑ –±–æ—Ç–∞.");
    return;
  }

  try{
    const r = await fetch(
      `${API_BASE}/api/homework_range?days_ahead=${DAYS_AHEAD}`,
      { headers: { "X-Telegram-InitData": initData } }
    );

    const data = await r.json();
    if (data?.error === "no_class"){
      showMessage("‚ÑπÔ∏è –¢—ã –Ω–µ –≤ –∫–ª–∞—Å—Å–µ",
        "–í—Å—Ç—É–ø–∏ –≤ –∫–ª–∞—Å—Å –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –î–ó.");
      return;
    }

    render(data.days || []);
  }catch(e){
    showMessage("üîå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
      "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–º–∞—à–∫—É.");
  }
})();
</script>

</body>
</html>
