<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–î–ó ‚Äî –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</title>
  <style>
    :root{--bg:#fff;--card:#fff;--text:#111;--muted:#666;--shadow:0 10px 25px rgba(0,0,0,.08);--border:#e9e9ef;--btn:#111;--btnText:#fff}
    [data-theme="dark"]{--bg:#0f1115;--card:#141824;--text:#f2f3f5;--muted:#a6adbb;--shadow:0 10px 25px rgba(0,0,0,.35);--border:#262b3a;--btn:#f2f3f5;--btnText:#111}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .top{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));backdrop-filter:saturate(1.2) blur(6px);padding:14px 16px 10px;display:flex;align-items:center;gap:12px}
    .title{font-weight:900;font-size:18px;display:flex;gap:8px;align-items:center}
    .sp{flex:1}
    .toggle{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted);user-select:none}
    .switch{width:44px;height:24px;border-radius:999px;background:var(--border);position:relative;cursor:pointer}
    .knob{width:18px;height:18px;border-radius:50%;background:var(--card);position:absolute;top:3px;left:3px;box-shadow:var(--shadow);transition:.18s}
    [data-theme="dark"] .knob{left:23px}
    .wrap{padding:10px 16px 18px;max-width:820px;margin:0 auto}
    .meta{color:var(--muted);font-size:13px;margin:2px 0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:10px 0}
    .subj{font-weight:900}
    .txt{white-space:pre-wrap;margin-top:6px;line-height:1.35}
    .hint{margin-top:10px;color:var(--muted);font-size:12px}
    .empty{padding:22px;border:1px dashed var(--border);border-radius:18px;color:var(--muted);text-align:center}
    .btn{margin-top:12px;display:inline-block;border-radius:14px;padding:10px 14px;font-weight:900;background:var(--btn);color:var(--btnText);cursor:pointer}
  </style>
</head>
<body>
  <div class="top">
    <div class="title">üìÖ –î–ó –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
    <div class="sp"></div>
    <div class="toggle" id="toggle"><span>–¢–µ–º–∞</span><div class="switch"><div class="knob"></div></div></div>
  </div>

  <div class="wrap">
    <div class="meta" id="meta">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    <div id="list"></div>
  </div>

<script>
  const API_BASE = "https://api.temo4ka4.ru";
  const tg = window.Telegram?.WebApp || null;
  if (tg) tg.ready();

  function setTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
  }
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") setTheme("dark");
  else setTheme("light");
  document.getElementById("toggle").onclick = () => {
    const cur = document.documentElement.getAttribute("data-theme");
    setTheme(cur === "light" ? "dark" : "light");
  };

  function esc(s){return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
  function showMessage(title, text){
    const root = document.getElementById("list");
    root.innerHTML = `<div class="empty"><b>${esc(title)}</b><br/>${esc(text)}</div>`;
  }
  function ensureTelegram(){
    if (!tg || !tg.initData) {
      showMessage("‚ö†Ô∏è –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram", "–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–∑ –±–æ—Ç–∞.");
      return false;
    }
    return true;
  }
  async function safeFetch(path){
    if (!ensureTelegram()) throw new Error("NO_TELEGRAM");
    try{
      const r = await fetch(API_BASE + path, {
        headers: { "X-Telegram-InitData": tg.initData }
      });
      if(!r.ok) throw new Error("SERVER_ERROR");
      return await r.json();
    }catch(e){
      showMessage("üîå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "–ü–æ–∫–∞ backend API –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.");
      throw e;
    }
  }

  function isoToday(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function render(items){
    const root=document.getElementById("list");
    root.innerHTML="";
    if(!items.length){
      root.innerHTML = `<div class="empty">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –î–ó –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
      return;
    }
    for(const it of items){
      const subj = it.subject?.trim() ? it.subject.trim() : "–û–±—â–µ–µ";
      const files = it.files_count>0 ? `<div class="hint">üìé –ï—Å—Ç—å —Ñ–∞–π–ª—ã (${it.files_count}). –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ—Ç–∫—Ä–æ–π –î–ó –≤ –±–æ—Ç–µ.</div>` : "";
      root.insertAdjacentHTML("beforeend", `
        <div class="card">
          <div class="subj">${esc(subj)} ‚Äî</div>
          <div class="txt">${esc(it.text||"‚Äî")}</div>
          ${files}
        </div>
      `);
    }
  }

  (async ()=>{
    const day = isoToday();
    document.getElementById("meta").textContent = `–î–∞—Ç–∞: ${day}`;
    try{
      const data = await safeFetch(`/api/homework?day=${encodeURIComponent(day)}`);
      if(data?.error==="no_class"){
        showMessage("‚ÑπÔ∏è –¢—ã –Ω–µ –≤ –∫–ª–∞—Å—Å–µ", "–í—Å—Ç—É–ø–∏ –≤ –∫–ª–∞—Å—Å –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –î–ó.");
        return;
      }
      render(data.items||[]);
    }catch(_){}
  })();
</script>
</body>
</html>
